stages:
  - build
  - test
  - deploy

variables:
  MAVEN_CLI_OPTS: "-s settings.xml --batch-mode --errors --fail-at-end --show-version"
  DOCKER_IMAGE: "maven:3.8.6-openjdk-17"

before_script:
  - echo "DÃ©marrage du pipeline CI/CD"

# ðŸŽ¯ Ã‰tape 1 : Build
build:
  stage: build
  image: $DOCKER_IMAGE
  script:
    - echo "Compilation du projet"
    - mvn $MAVEN_CLI_OPTS clean package -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1h

# ðŸŽ¯ Ã‰tape 2 : Tests
test:
  stage: test
  image: $DOCKER_IMAGE
  script:
    - echo "ExÃ©cution des tests unitaires"
    - mvn $MAVEN_CLI_OPTS test
  only:
    - main
    - develop

# ðŸŽ¯ Ã‰tape 3 : DÃ©ploiement en staging (branche main uniquement)
deploy:
  stage: deploy
  only:
    - main
  script:
    - echo "DÃ©ploiement de l'application en staging"
    - scp target/*.jar user@staging-server:/opt/app/
    - ssh user@staging-server 'systemctl restart springboot-app'
  when: manual  # DÃ©ploiement manuel pour Ã©viter un dÃ©ploiement automatique
  
deploy-production:
  stage: deploy
  only:
    - main
  script:
    - echo "DÃ©ploiement en production"
    - scp target/*.jar user@prod-server:/opt/app/
    - ssh user@prod-server 'systemctl restart springboot-app'
  when: manual  # Validation manuelle requise
